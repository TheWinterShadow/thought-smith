# Continuous Integration workflow for Thought Smith Android App
#
# This workflow runs on every push and pull request to ensure code quality
# and functionality through automated testing and validation.
#
# Features:
# - Kotlin code linting with ktlint
# - Android Lint static analysis
# - Unit test execution
# - Instrumented test execution (if available)
# - Build verification for debug variants
# - Caching for faster builds
#
# Triggers:
# - Push to main branch
# - Pull requests targeting main branch
# - Manual workflow dispatch for testing
#
# @author TheWinterShadow
# @since 1.0.0

name: CI - Build and Test

on:
    # Trigger on pushes to main branch
    push:
        branches: [main]

    # Trigger on pull requests targeting main
    pull_request:
        branches: [main]

    # Allow manual workflow execution
    workflow_dispatch:

# Ensure only one CI workflow runs at a time per branch
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # Lint and static analysis job
    lint:
        name: Code Linting and Static Analysis
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  # Fetch full history for accurate analysis
                  fetch-depth: 0

            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  java-version: "17"
                  distribution: "temurin"

            - name: Setup Android SDK
              uses: android-actions/setup-android@v3

            - name: Cache Gradle dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                  restore-keys: |
                      ${{ runner.os }}-gradle-

            - name: Make gradlew executable
              run: chmod +x ./gradlew

            - name: Run ktlint (Kotlin linting)
              run: ./gradlew ktlintCheck
              continue-on-error: false

            - name: Run Android Lint
              run: ./gradlew lintDebug
              continue-on-error: false

            - name: Upload lint reports
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: lint-reports
                  path: |
                      app/build/reports/lint-results-debug.html
                      app/build/reports/lint-results-debug.xml
                      app/build/reports/ktlint/

    # Unit testing job
    test:
        name: Unit Tests
        runs-on: ubuntu-latest
        needs: lint

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  java-version: "17"
                  distribution: "temurin"

            - name: Setup Android SDK
              uses: android-actions/setup-android@v3

            - name: Cache Gradle dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                  restore-keys: |
                      ${{ runner.os }}-gradle-

            - name: Make gradlew executable
              run: chmod +x ./gradlew

            - name: Run unit tests
              run: ./gradlew testDebugUnitTest

            - name: Upload test results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: test-results
                  path: |
                      app/build/reports/tests/testDebugUnitTest/
                      app/build/test-results/testDebugUnitTest/

    # Build verification job
    build:
        name: Build Verification
        runs-on: ubuntu-latest
        needs: [lint, test]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  java-version: "17"
                  distribution: "temurin"

            - name: Setup Android SDK
              uses: android-actions/setup-android@v3

            - name: Cache Gradle dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                  restore-keys: |
                      ${{ runner.os }}-gradle-

            - name: Make gradlew executable
              run: chmod +x ./gradlew

            - name: Build debug APK
              run: ./gradlew assembleDebug

            - name: Verify APK was created
              run: |
                  if [ ! -f app/build/outputs/apk/debug/app-debug.apk ]; then
                    echo "❌ Debug APK was not created"
                    exit 1
                  else
                    echo "✅ Debug APK created successfully"
                    ls -la app/build/outputs/apk/debug/
                  fi

    # Instrumented tests (Android tests) - runs on emulator
    instrumented-test:
        name: Instrumented Tests
        runs-on: ubuntu-latest
        needs: build

        # Use strategy matrix for different API levels if needed
        strategy:
            matrix:
                api-level: [33] # Test on minimum supported API level

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  java-version: "17"
                  distribution: "temurin"

            - name: Setup Android SDK
              uses: android-actions/setup-android@v3

            - name: Cache Gradle dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                  restore-keys: |
                      ${{ runner.os }}-gradle-

            - name: Make gradlew executable
              run: chmod +x ./gradlew

            - name: Enable KVM group perms
              run: |
                  echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
                  sudo udevadm control --reload-rules
                  sudo udevadm trigger --name-match=kvm

            - name: AVD cache
              uses: actions/cache@v4
              id: avd-cache
              with:
                  path: |
                      ~/.android/avd/*
                      ~/.android/adb*
                  key: avd-${{ matrix.api-level }}

            - name: Create AVD and generate snapshot for caching
              if: steps.avd-cache.outputs.cache-hit != 'true'
              uses: reactivecircus/android-emulator-runner@v2
              with:
                  api-level: ${{ matrix.api-level }}
                  target: google_apis
                  arch: x86_64
                  profile: Nexus 6
                  force-avd-creation: false
                  emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
                  disable-animations: false
                  script: echo "Generated AVD snapshot for caching."

            - name: Run instrumented tests
              uses: reactivecircus/android-emulator-runner@v2
              with:
                  api-level: ${{ matrix.api-level }}
                  target: google_apis
                  arch: x86_64
                  profile: Nexus 6
                  force-avd-creation: false
                  emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
                  disable-animations: true
                  script: ./gradlew connectedDebugAndroidTest

            - name: Upload instrumented test results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: instrumented-test-results
                  path: |
                      app/build/reports/androidTests/connected/
                      app/build/outputs/androidTest-results/connected/
